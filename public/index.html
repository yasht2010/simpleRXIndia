<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartRx</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>@media print { .no-print { display: none !important; } body { background: white; } .print-area { border: none; box-shadow: none; padding: 0; } }</style>
</head>
<body class="bg-gray-100 min-h-screen p-4 font-sans">

    <!-- LOGIN UI -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-md">
            <h1 class="text-2xl font-bold text-blue-900 mb-2">SmartRx Pro ðŸ©º</h1>
            <input id="loginPhone" placeholder="Phone Number" class="w-full border p-3 rounded mb-3">
            <input id="loginPass" type="password" placeholder="Password" class="w-full border p-3 rounded mb-4">
            <button onclick="login()" class="w-full bg-blue-600 text-white p-3 rounded font-bold hover:bg-blue-700">Login</button>
            <p onclick="toggleRegister()" class="text-center text-xs text-gray-400 mt-4 cursor-pointer hover:underline">Register</p>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="appScreen" class="hidden min-h-screen flex flex-col items-center p-4">
        <div class="w-full max-w-3xl flex justify-between items-center mb-4 no-print">
            <div class="text-blue-900 font-bold">SmartRx</div>
            <div class="flex gap-4 text-sm font-medium">
                <span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full">Credits: â‚¹<span id="creditDisplay">0</span></span>
                <button onclick="logout()" class="text-red-500">Logout</button>
            </div>
        </div>

        <div class="max-w-3xl w-full bg-white rounded-xl shadow-xl overflow-hidden print-area min-h-[85vh] flex flex-col relative">
            <div id="docHeader" contenteditable="true" class="p-8 border-b-2 border-gray-800 cursor-text hover:bg-gray-50 transition" onblur="saveHeader()"></div>
            <div id="livePreview" class="px-8 pt-2 text-gray-400 text-sm italic h-6 overflow-hidden"></div>
            <div id="content" contenteditable="true" class="p-8 flex-grow prose max-w-none focus:outline-none">
                <p id="placeholder" class="text-gray-300 italic no-print">Press Spacebar to dictate...</p>
            </div>
            <div id="timerDisplay" class="hidden absolute top-4 right-4 bg-black text-white px-3 py-1 rounded-full text-xs font-mono z-10 opacity-80">05:00</div>

            <div class="bg-gray-50 p-4 border-t no-print">
                <div class="flex justify-center mb-4 relative">
                    <button id="recordBtn" class="bg-red-600 text-white w-16 h-16 rounded-full shadow-lg transition-all flex items-center justify-center active:scale-95">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                    </button>
                </div>
                <p id="status" class="text-center text-xs text-gray-500 font-bold mb-4 h-4 overflow-hidden text-ellipsis whitespace-nowrap px-4">READY</p>
                <div class="flex justify-between items-center">
                    <button onclick="document.getElementById('macroModal').classList.remove('hidden')" class="text-blue-600 text-sm font-semibold underline">ðŸ’Š Voice Macros</button>
                    <div class="flex gap-2">
                        <button onclick="window.location.reload()" class="px-3 py-1 text-gray-500 text-xs">New Patient</button>
                        <button onclick="window.print()" class="bg-gray-900 text-white px-4 py-2 rounded text-sm font-bold">Print</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SETTINGS & MACRO MODALS (Standard) -->
    <div id="settingsModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 no-print">
        <div class="bg-white rounded p-6 w-full max-w-lg shadow-xl">
            <h2 class="font-bold mb-4">Settings</h2>
            <input id="in_name" placeholder="Name" class="w-full border p-2 mb-2 rounded">
            <input id="in_qual" placeholder="Qualifications" class="w-full border p-2 mb-2 rounded">
            <input id="in_reg" placeholder="Reg No" class="w-full border p-2 mb-2 rounded">
            <textarea id="in_clinic" placeholder="Clinic Address" class="w-full border p-2 mb-2 rounded"></textarea>
            <input id="in_keywords" placeholder="Keywords (Brand names)" class="w-full border p-2 mb-2 bg-yellow-50 rounded">
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('settingsModal').classList.add('hidden')" class="px-4 py-2 text-gray-600">Cancel</button>
                <button onclick="saveSettings()" class="bg-blue-600 text-white px-4 py-2 rounded">Save</button>
            </div>
        </div>
    </div>

    <div id="macroModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 no-print">
        <div class="bg-white rounded p-6 w-full max-w-md shadow-xl">
            <h2 class="font-bold mb-4">Macros</h2>
            <input id="macroTrigger" placeholder="Trigger" class="w-full border p-2 mb-2 rounded">
            <textarea id="macroExpansion" placeholder="Expansion..." class="w-full border p-2 mb-2 rounded h-20"></textarea>
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('macroModal').classList.add('hidden')" class="px-4 py-2 text-gray-600">Close</button>
                <button onclick="saveMacro()" class="bg-blue-600 text-white px-4 py-2 rounded">Save</button>
            </div>
            <div id="macroList" class="mt-4 pt-4 border-t text-xs h-32 overflow-y-auto"></div>
        </div>
    </div>

    <script>
        const getApiBase = () => {
            if (window.location.protocol === 'blob:' || window.location.origin === 'null') {
                return 'http://localhost:3000';
            }
            const host = window.location.hostname;
            if (host === 'localhost' || host === '127.0.0.1') {
                return window.location.port === '3000' ? '' : 'http://localhost:3000';
            }
            return '';
        };
        const API_BASE = getApiBase();
        const socket = API_BASE ? io(API_BASE) : io();
        
        let mediaRecorder, isRecording = false, transcriptBuffer = "", startTime = 0, timerInterval;
        let backupAudioChunks = [];
        let recordedMimeType = ''; // To store the browser's native mime type

        // --- AUTH ---
        window.onload = initApp;
        async function login() {
            const phone = document.getElementById('loginPhone').value;
            const pass = document.getElementById('loginPass').value;
            const res = await fetch('/api/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ phone, password: pass }) });
            const data = await res.json();
            if (data.success) initApp(); else alert("Login Failed");
        }
        async function toggleRegister() {
            const phone = prompt("New Phone:"); const pass = prompt("New Password:");
            if(phone && pass) { await fetch('/api/register', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ phone, password: pass }) }); alert("Registered. Please login."); }
        }
        async function logout() { location.reload(); }
        async function initApp() {
            try {
                const res = await fetch('/api/me');
                if (res.status === 401) throw new Error("Unauthorized");
                const data = await res.json();
                document.getElementById('creditDisplay').innerText = data.credits;
                document.getElementById('docHeader').innerHTML = data.header_html || "<h1>Dr. Name</h1><p>Edit Header...</p>";
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appScreen').classList.remove('hidden');
                loadMacros();
            } catch (e) {}
        }
        async function saveHeader() {
            await fetch('/api/header', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ html: document.getElementById('docHeader').innerHTML }) });
        }

        // --- SOCKET EVENTS ---
        socket.on('transcript-update', (data) => {
            const statusEl = document.getElementById('status');
            if (data.isFinal) {
                transcriptBuffer += " " + data.text;
                document.getElementById('livePreview').innerText = "";
                // Show last captured phrase in status
                statusEl.innerText = "CAPTURED: " + data.text;
                statusEl.classList.remove('text-gray-500');
                statusEl.classList.add('text-blue-600');
            } else {
                document.getElementById('livePreview').innerText = data.text;
                // Show hearing phrase
                statusEl.innerText = "HEARING: " + data.text;
                statusEl.classList.remove('text-gray-500');
                statusEl.classList.add('text-red-500');
            }
        });

        socket.on('prescription-result', (data) => {
            handleResult(data);
        });

        socket.on('use-backup-upload', () => {
            document.getElementById('status').innerText = "USING BACKUP...";
            document.getElementById('status').className = "text-center text-xs text-yellow-600 font-bold mb-4";
            uploadBackup();
        });

        function handleResult(data) {
            const status = document.getElementById('status');
            const btn = document.getElementById('recordBtn');
            btn.classList.remove('bg-red-500', 'animate-pulse');
            if (data.success) {
                document.getElementById('content').innerHTML = data.html;
                document.getElementById('creditDisplay').innerText = data.credits;
                status.innerText = "DONE";
                status.className = "text-center text-xs text-green-600 font-bold mb-4";
            } else {
                alert(data.error);
                status.innerText = "ERROR";
            }
        }

        // --- RECORDING (Native Streaming) ---
        async function startRecording() {
            if (isRecording) return;
            transcriptBuffer = "";
            backupAudioChunks = [];
            startTime = Date.now();
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Allow browser to choose native format (WebM/MP4)
                mediaRecorder = new MediaRecorder(stream);
                recordedMimeType = mediaRecorder.mimeType; 
                console.log("Recording with mimeType:", recordedMimeType);
                
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        socket.emit('audio-stream', e.data); // Send to Live
                        backupAudioChunks.push(e.data); // Save for Backup
                    }
                };

                mediaRecorder.start(500); // 500ms chunks

                isRecording = true;
                const btn = document.getElementById('recordBtn');
                btn.classList.add('bg-red-500', 'animate-pulse');
                document.getElementById('status').innerText = "LISTENING...";
                startTimer();

            } catch (e) { alert("Mic Error: " + e.message); }
        }

        function stopRecording() {
            if (!isRecording) return;
            isRecording = false;
            clearInterval(timerInterval);
            document.getElementById('timerDisplay').classList.add('hidden');

            if(mediaRecorder) mediaRecorder.stop();
            if(mediaRecorder && mediaRecorder.stream) mediaRecorder.stream.getTracks().forEach(t => t.stop());

            const duration = Date.now() - startTime;
            if (duration < 2000) { 
                document.getElementById('status').innerText = "Cancelled (<2s)";
                document.getElementById('recordBtn').classList.remove('bg-red-500', 'animate-pulse');
                return;
            }

            document.getElementById('status').innerText = "FORMATTING...";
            const cleanContext = document.getElementById('placeholder') ? "" : document.getElementById('content').innerHTML;
            
            const pendingPreview = document.getElementById('livePreview').innerText;
            const fullText = (transcriptBuffer + " " + pendingPreview).trim();

            setTimeout(() => {
                socket.emit('finalize-prescription', { fullTranscript: fullText, context: cleanContext });
            }, 2500);
        }

        // --- BACKUP UPLOAD ---
        async function uploadBackup() {
            const blob = new Blob(backupAudioChunks, { type: recordedMimeType });
            const formData = new FormData();
            formData.append('audio', blob, 'backup_audio');
            formData.append('context', document.getElementById('placeholder') ? "" : document.getElementById('content').innerHTML);

            try {
                const res = await fetch('/api/process-backup', { method: 'POST', body: formData });
                const data = await res.json();
                handleResult(data);
            } catch (e) {
                alert("Backup Upload Failed: " + e.message);
            }
        }

        function startTimer() {
            const timerEl = document.getElementById('timerDisplay');
            timerEl.classList.remove('hidden');
            let secondsLeft = 300;
            timerInterval = setInterval(() => {
                secondsLeft--;
                const m = Math.floor(secondsLeft / 60);
                const s = secondsLeft % 60;
                timerEl.innerText = `0${m}:${s < 10 ? '0'+s : s}`;
                if (secondsLeft <= 0) stopRecording();
            }, 1000);
        }

        // Events
        const b = document.getElementById('recordBtn');
        b.addEventListener('mousedown', startRecording);
        b.addEventListener('mouseup', stopRecording);
        b.addEventListener('touchstart', (e)=>{e.preventDefault(); startRecording()});
        b.addEventListener('touchend', (e)=>{e.preventDefault(); stopRecording()});
        document.addEventListener('keydown', (e) => { if(e.code==='Space' && !e.repeat && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') startRecording(); });
        document.addEventListener('keyup', (e) => { if(e.code==='Space') stopRecording(); });

        // Macros Logic
        function openSettings() { document.getElementById('settingsModal').classList.remove('hidden'); }
        function openMacros() { 
            document.getElementById('macroModal').classList.remove('hidden'); 
            loadMacros();
        }
        async function loadMacros() {
            const res = await fetch('/api/macros');
            const data = await res.json();
            document.getElementById('macroList').innerHTML = data.map(m => `<div class="border-b py-1"><b>${m.trigger_phrase}:</b> ${m.expansion}</div>`).join('');
        }
        async function saveMacro() {
            await fetch('/api/macros', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ trigger: document.getElementById('macroTrigger').value, expansion: document.getElementById('macroExpansion').value })
            });
            document.getElementById('macroTrigger').value = ''; document.getElementById('macroExpansion').value = '';
            loadMacros();
        }
    </script>
</body>
</html>